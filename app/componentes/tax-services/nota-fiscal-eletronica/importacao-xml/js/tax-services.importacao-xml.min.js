angular.module("tax-services-importacao-xml",[]).controller("tax-services-importacao-xmlCtrl",["$scope","$state","$http","$window","$webapi","$apis","$timeout","Upload","$filter",function(a,o,e,t,r,i,n,s,l){a.paginaInformada=1,a.filiais=[],a.manifestos=[],a.almoxarifados=[],a.natOperacoes=[],a.Mensagens=[],a.itens_pagina=[50,100,150,200],a.statusmanifesto=[],a.filtro={datamin:new Date,datamax:"",data:"Recebimento",statusmanifesto:null,destinatario:null,emitente:"",itens_pagina:a.itens_pagina[0],pagina:1,total_registros:0,faixa_registros:"0-0",total_paginas:0,chaveAcesso:null},a.total={nfe:0},a.notadetalhada=void 0,a.nrChave="",a.dadosImportacao={},a.uploadXml={cdGrupo:"",xml:""};var u=0,d=1,f=void 0;a.tab=1,a.tabFiltro=1,a.exibeTela=!1,a.abrirCalendarioDataMin=!1,a.abrirCalendarioDataMax=!1,a.abrirCalendarioDataEntrada=!1,a.taxServices_importacaoXMLInit=function(){a.pagina.titulo="Nota Fiscal Eletrônica",a.pagina.subtitulo="Importação XML",a.$on("mudancaDeRota",function(a,e,t){o.go(e,t)}),a.$on("alterouGrupoEmpresa",function(){a.exibeTela&&(a.usuariologado.grupoempresa?(a.filtro.destinatario=null,p()):a.filiais=[])}),a.$on("acessoDeTelaNotificado",function(){a.exibeTela=!0,p()}),a.$emit("acessouTela")},a.importaXml=function(){if(a.uploadXml.xml&&null!==a.uploadXml.xml){if(!a.usuariologado.grupoempresa)return void a.showModalAlerta("Por favor, selecione uma empresa","Atos Capital","OK",function(){n(function(){a.setVisibilidadeBoxGrupoEmpresa(!0)},300)});a.showProgress(),s.upload({url:i.getUrl(i.tax.tbmanifesto,a.token,[{id:103,valor:a.usuariologado.grupoempresa.id_grupo}]),file:a.uploadXml.xml,method:"PATCH"}).success(function(o){n(function(){a.hideProgress(),o&&null!=o&&(200===o.cdMensagem?(a.tabFiltro=2,a.filtro.chaveAcesso=o.dsMensagem,h()):a.showModalAlerta(o.dsMensagem))})}).error(function(o,e){0===e?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e||404===e?a.voltarTelaLogin():a.showAlert("Houve uma falha ao fazer upload do XML da Nota Fiscal ("+e+")",!0,"danger",!0,!1),a.hideProgress()})}};var c=function(o){o>=1&&o<=a.filtro.total_paginas&&(a.filtro.pagina=o,h()),a.atualizaPaginaDigitada()};a.retrocedePagina=function(){c(a.filtro.pagina-1)},a.avancaPagina=function(){c(a.filtro.pagina+1)},a.alteraPagina=function(){a.paginaInformada?c(parseInt(a.paginaInformada)):a.atualizaPaginaDigitada()},a.atualizaPaginaDigitada=function(){a.paginaInformada=a.filtro.pagina},a.alterouItensPagina=function(){a.manifestos.length>0&&h()};var g=function(){var o=[];if(1===a.tabFiltro){var e=void 0;e="Emissão"===a.filtro.data?{id:108,valor:a.getFiltroData(a.filtro.datamin)}:{id:120,valor:a.getFiltroData(a.filtro.datamin)},a.filtro.datamax&&(e.valor=e.valor+"|"+a.getFiltroData(a.filtro.datamax)),o.push(e),a.filtro.destinatario&&null!==a.filtro.destinatario&&o.push({id:104,valor:a.filtro.destinatario.nu_cnpj}),a.filtro.emitente&&""!==a.filtro.emitente&&o.push({id:105,valor:a.filtro.emitente}),a.filtro.statusmanifesto&&null!==a.filtro.statusmanifesto&&o.push({id:113,valor:a.filtro.statusmanifesto.id})}else a.filtro.chaveAcesso&&null!==a.filtro.chaveAcesso&&o.push({id:101,valor:a.filtro.chaveAcesso});return o.length>0?o:void 0};a.limpaFiltros=function(){a.filtro.datamin=new Date,a.filtro.datamax="",f=void 0,a.filtro.destinatario=a.filtro.statusmanifesto=null,a.filtro.emitente="",a.filtro.chaveAcesso=""};var m=function(){a.filtro.datamax&&a.filtro.datamax<a.filtro.datamin&&(a.filtro.datamax=a.filtro.datamin),a.$$phase||a.$apply()};a.exibeCalendarioDataMin=function(o){o&&(o.preventDefault(),o.stopPropagation()),a.abrirCalendarioDataMin=!a.abrirCalendarioDataMin,a.abrirCalendarioDataMax=!1},a.alterouDataMin=function(){m()},a.exibeCalendarioDataMax=function(o){o&&(o.preventDefault(),o.stopPropagation()),a.abrirCalendarioDataMax=!a.abrirCalendarioDataMax,a.abrirCalendarioDataMin=!1},a.alterouDataMax=function(){null===a.filtro.datamax?a.filtro.datamax="":m()};var p=function(o){if(a.usuariologado.grupoempresa&&null!==a.usuariologado.grupoempresa){a.showProgress(u,1e4);var e=[];e.push({id:114,valor:1}),a.usuariologado.grupoempresa&&(e.push({id:116,valor:a.usuariologado.grupoempresa.id_grupo}),a.usuariologado.empresa&&e.push({id:100,valor:a.usuariologado.empresa.nu_cnpj})),r.get(i.getUrl(i.cliente.empresa,[a.token,0,104],e)).then(function(e){a.filiais=e.Registros,a.filtro.destinatario=o?l("filter")(a.filiais,function(a){return a.nu_cnpj===o})[0]:null,a.hideProgress(u)},function(o){0===o.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===o.status||404===o.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter filiais ("+o.status+")",!0,"danger",!0),a.hideProgress(u)})}};a.alterouDestinatario=function(){},a.incrementaTotalNFes=function(o){"number"==typeof o&&(a.total.nfe+=o)},a.buscaManifestos=function(){if(!a.usuariologado.grupoempresa)return void a.showModalAlerta("Por favor, selecione uma empresa","Atos Capital","OK",function(){n(function(){a.setVisibilidadeBoxGrupoEmpresa(!0)},300)});if(a.filtro.datamax){var o=Math.abs(a.filtro.datamax.getTime()-a.filtro.datamin.getTime()),e=Math.ceil(o/864e5);if(e>31){var t=366>=e?e+" dias":"mais de um ano";return void a.showModalAlerta("Por favor, selecione um intervalo de data de no máximo 31 dias. (Sua seleção consta "+t+")","Atos Capital","OK",function(){n(function(){a.exibeCalendarioDataMax()},300)})}}h()};var h=function(){a.showProgress(u,1e4),a.showProgress(d);var o=g();void 0!=o?r.get(i.getUrl(i.tax.tbmanifesto,[a.token,5,108,0,a.filtro.itens_pagina,a.filtro.pagina],o)).then(function(e){if(f=o,a.total.nfe=0,a.manifestos=e.Registros,a.filtro.total_registros=e.TotalDeRegistros,a.filtro.total_paginas=Math.ceil(a.filtro.total_registros/a.filtro.itens_pagina),0===a.manifestos.length)a.faixa_registros="0-0";else{var t=(a.filtro.pagina-1)*a.filtro.itens_pagina+1,r=t-1+a.filtro.itens_pagina;r>a.filtro.total_registros&&(r=a.filtro.total_registros),a.filtro.faixa_registros=t+"-"+r}a.filtro.pagina>a.filtro.total_paginas&&c(1),a.hideProgress(u),a.hideProgress(d)},function(o){0===o.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===o.status||404===o.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter manifestos ("+o.status+")",!0,"danger",!0),a.hideProgress(u),a.hideProgress(d)}):2===a.tabFiltro&&(a.hideProgress(u),a.hideProgress(d),a.showModalAlerta("Por favor, digite a Chave de Acesso","Atos Capital","OK",function(){}))};a.toggle=function(a){a&&null!==a&&(a.collapsed=a.collapsed?!1:!0)},a.isExpanded=function(a){return a&&null!==a?a.collapsed:void 0},a.downloadDANFE=function(o,e){var t=void 0,r=3,n=o.nrEmitenteCNPJCPF+".zip";if("number"==typeof e){var s=o.notas[e];r=2,t={id:100,valor:s.idManifesto},n=s.nrChave+".pdf"}else f?(t=[],angular.copy(f,t),t.push({id:105,valor:o.nrEmitenteCNPJCPF})):t={id:105,valor:o.nrEmitenteCNPJCPF};a.download(i.getUrl(i.util.utilnfe,[a.token,r,108],t),n,!0,d,u)},a.downloadXML=function(o,e){var t=void 0,r=1,n=o.nrEmitenteCNPJCPF+".zip";if("number"==typeof e){var s=o.notas[e];r=0,t={id:100,valor:s.idManifesto},n=s.nrChave+".xml"}else f?(t=[],angular.copy(f,t),t.push({id:105,valor:o.nrEmitenteCNPJCPF})):t={id:105,valor:o.nrEmitenteCNPJCPF};a.download(i.getUrl(i.util.utilnfe,[a.token,r,108],t),n,!0,d,u)},a.getCodigoTracoDescricao=function(a){var o="";return a&&("number"==typeof a.codigo||"string"==typeof a.codigo?(o=a.codigo+"","string"==typeof a.descricao?o+=" - "+a.descricao:"string"==typeof a.nome&&(o+=" - "+a.nome)):"string"==typeof a.descricao?o=a.descricao:"string"==typeof a.nome&&(o=a.nome)),o};var v=function(o,e,t){a.showProgress(u,1e4),a.showProgress(d);var n={id:100,valor:o};r.get(i.getUrl(i.tax.tbmanifesto,[a.token,4],n)).then(function(o){a.notadetalhada=void 0,o.Registros.length>0&&(a.notadetalhada=o.Registros[0].notas[0],a.notadetalhada.nrChave=e),"function"==typeof t&&t(),a.hideProgress(u),a.hideProgress(d)},function(o){0===o.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===o.status||404===o.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter detalhes da NF-e ("+o.status+")",!0,"danger",!0),a.hideProgress(u),a.hideProgress(d)})},P=function(o,e){a.showProgress(u,1e4),a.showProgress(d);var t={id:200,valor:o};r.get(i.getUrl(i.rezende.pgsql.tbalmoxarifado,[a.token,1,100,0],t)).then(function(o){a.almoxarifados=void 0,o.Registros.length>0&&(a.almoxarifados=o.Registros),"function"==typeof e&&e(),a.hideProgress(u),a.hideProgress(d)},function(o){0===o.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===o.status||404===o.status?a.showAlert("Serviço indisponível no momento. Por favor tente mais tarde",!0,"warning",!0):a.showAlert("Houve uma falha ao obter os almaxorifados para importação ("+o.status+")",!0,"danger",!0),a.hideProgress(u),a.hideProgress(d)})};a.exibeCalendarioDataEntrada=function(o){o&&(o.preventDefault(),o.stopPropagation()),a.abrirCalendarioDataEntrada=!a.abrirCalendarioDataEntrada};var w=function(o,e){a.showProgress(u,1e4),a.showProgress(d),r.get(i.getUrl(i.rezende.pgsql.tbnaturezaoperacao,[a.token,o])).then(function(o){a.natOperacoes=void 0,o.Registros.length>0&&(a.natOperacoes=o.Registros),"function"==typeof e&&e(),a.hideProgress(u),a.hideProgress(d)},function(o){0===o.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===o.status||404===o.status?a.showAlert("Serviço indisponível no momento. Por favor tente mais tarde",!0,"warning",!0):a.showAlert("Houve uma falha ao obter a natureza da operação para importação da NFe("+o.status+")",!0,"danger",!0),a.hideProgress(u),a.hideProgress(d)})};a.detalhar=function(o,e){var t=o.notas[e];a.notadetalhada&&a.notadetalhada.idManifesto===t.idManifesto?$("#modalDetalhes").modal("show"):v(t.idManifesto,t.nrChave,function(){$("#modalDetalhes").modal("show")})},a.obterInformarcoesImportar=function(o,e){var t=o.notas[e],r=o.UF,i=1;return"SE"!=r&&(i=2),null==t.dtEntrega?void a.showModalAlerta("A nota não está disponível para importação, pois a mesma ainda não foi recebida."):(a.nrChave=t.nrChave,a.dtEntrega=t.dtEntrega,P(t.nrCNPJ,function(){$("#modalImportar").modal("show")}),w(i,function(){$("#modalImportar").modal("show")}),void 0)},a.importarNota=function(){if(!a.dadosImportacao||null===a.dadosImportacao)return void a.showModalAlerta("É necessário selecionar a Natureza da Operação e o Almoxarifado!");if(!a.dadosImportacao.natOperacao||null===a.dadosImportacao.natOperacao)return void a.showModalAlerta("É necessário selecionar a Natureza da Operação!");if(!a.dadosImportacao.almoxarifado||null===a.dadosImportacao.almoxarifado)return void a.showModalAlerta("É necessário selecionar o Almoxarifado!");if(!a.dtEntrega||null===a.dtEntrega)return void a.showModalAlerta("Favor informar a data de Entrada da Nota!");var o={nrChave:a.nrChave,codAlmoxarifado:a.dadosImportacao.almoxarifado.cod_almoxarifado,codNaturezaOperacao:a.dadosImportacao.natOperacao.cdNaturezaOperacao,dtEntrega:a.dtEntrega};a.showProgress(),r.post(i.getUrl(i.rezende.pgsql.tabnotafiscalentrada,void 0,{id:"token",valor:a.token}),o).then(function(o){a.hideProgress(),o&&null!=o?200===o.cdMensagem?(x(),a.showModalAlerta("Nota Fiscal incluída com sequência: "+o.sqNota+".")):(x(),a.Mensagens=o.Erro,b()):x()},function(o){x(),0===o.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===o.status||404===o.status?a.showAlert("Serviço indisponível no momento. Por favor tente mais tarde",!0,"warning",!0):a.showAlert("Houve uma falha ao importar a NFe ("+o.status+")",!0,"danger",!0),a.hideProgress()}),a.dadosImportacao=null};var x=function(){$("#modalImportar").modal("hide")},b=function(){$("#modalRetornoImportacao").modal("show")};a.imprimir=function(o,e){var r=o.notas[e];t.open("views/impressao-nfe#?k="+r.nrChave+"&t="+a.token,"_blank")},a.tabIs=function(o){return a.tab===o},a.setTab=function(o){o>=1&&8>=o&&(a.tab=o)},a.tabFiltroIs=function(o){return a.tabFiltro===o},a.setTabFiltro=function(o){o>=1&&2>=o&&(a.tabFiltro=o)},a.exibeOpcaoImportar=function(){return!a.usuariologado.grupoempresa||6!==a.usuariologado.grupoempresa.id_grupo&&15!==a.usuariologado.grupoempresa.id_grupo?!1:!0}}]);