angular.module("tax-services-importacao-xml",[]).controller("tax-services-importacao-xmlCtrl",["$scope","$state","$http","$window","$webapi","$apis","$timeout","Upload","$filter",function(a,e,o,i,r,t,s,n,l){a.paginaInformada=1,a.filiais=[],a.manifestos=[],a.almoxarifados=[],a.natOperacoes=[],a.Mensagens=[],a.itens_pagina=[50,100,150,200],a.statusmanifesto=[],a.filtro={datamin:new Date,datamax:"",data:"Recebimento",statusmanifesto:null,destinatario:null,emitente:"",itens_pagina:a.itens_pagina[0],pagina:1,total_registros:0,faixa_registros:"0-0",total_paginas:0,chaveAcesso:null},a.total={nfe:0},a.notadetalhada=void 0,a.nrChave="",a.dadosImportacao={},a.uploadXml={cdGrupo:"",xml:""};var u=0,f=1,d=void 0;a.tab=1,a.tabFiltro=1,a.exibeTela=!1,a.abrirCalendarioDataMin=!1,a.abrirCalendarioDataMax=!1,a.abrirCalendarioDataEntrada=!1,a.taxServices_importacaoXMLInit=function(){a.pagina.titulo="Nota Fiscal Eletrônica",a.pagina.subtitulo="Importação XML",a.$on("mudancaDeRota",function(a,o,i){e.go(o,i)}),a.$on("alterouGrupoEmpresa",function(){a.exibeTela&&(a.usuariologado.grupoempresa?(a.filtro.destinatario=null,m()):a.filiais=[])}),a.$on("acessoDeTelaNotificado",function(){a.exibeTela=!0,m()}),a.$emit("acessouTela")},a.importaXml=function(){if(a.uploadXml.xml&&null!==a.uploadXml.xml){if(!a.usuariologado.grupoempresa)return void a.showModalAlerta("Por favor, selecione uma empresa","Atos Capital","OK",function(){s(function(){a.setVisibilidadeBoxGrupoEmpresa(!0)},300)});a.showProgress(),n.upload({url:t.getUrl(t.tax.tbmanifesto,a.token,[{id:103,valor:a.usuariologado.grupoempresa.id_grupo}]),file:a.uploadXml.xml,method:"PATCH"}).success(function(e){s(function(){a.hideProgress(),e&&null!=e&&(200===e.cdMensagem?(a.tabFiltro=2,a.filtro.chaveAcesso=e.dsMensagem,h()):a.showModalAlerta(e.dsMensagem))})}).error(function(e,o){0===o?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===o||404===o?a.voltarTelaLogin():a.showAlert("Houve uma falha ao fazer upload do XML da Nota Fiscal ("+o+")",!0,"danger",!0,!1),a.hideProgress()})}};var c=function(e){e>=1&&e<=a.filtro.total_paginas&&(a.filtro.pagina=e,h()),a.atualizaPaginaDigitada()};a.retrocedePagina=function(){c(a.filtro.pagina-1)},a.avancaPagina=function(){c(a.filtro.pagina+1)},a.alteraPagina=function(){a.paginaInformada?c(parseInt(a.paginaInformada)):a.atualizaPaginaDigitada()},a.atualizaPaginaDigitada=function(){a.paginaInformada=a.filtro.pagina},a.alterouItensPagina=function(){a.manifestos.length>0&&h()};var g=function(){var e=[];if(1===a.tabFiltro){var o=void 0;o="Emissão"===a.filtro.data?{id:108,valor:a.getFiltroData(a.filtro.datamin)}:{id:120,valor:a.getFiltroData(a.filtro.datamin)},a.filtro.datamax&&(o.valor=o.valor+"|"+a.getFiltroData(a.filtro.datamax)),e.push(o),a.filtro.destinatario&&null!==a.filtro.destinatario&&e.push({id:104,valor:a.filtro.destinatario.nu_cnpj}),a.filtro.emitente&&""!==a.filtro.emitente&&e.push({id:105,valor:a.filtro.emitente}),a.filtro.statusmanifesto&&null!==a.filtro.statusmanifesto&&e.push({id:113,valor:a.filtro.statusmanifesto.id})}else a.filtro.chaveAcesso&&null!==a.filtro.chaveAcesso&&e.push({id:101,valor:a.filtro.chaveAcesso});return e.length>0?e:void 0};a.limpaFiltros=function(){a.filtro.datamin=new Date,a.filtro.datamax="",d=void 0,a.filtro.destinatario=a.filtro.statusmanifesto=null,a.filtro.emitente="",a.filtro.chaveAcesso=""};var p=function(){a.filtro.datamax&&a.filtro.datamax<a.filtro.datamin&&(a.filtro.datamax=a.filtro.datamin),a.$$phase||a.$apply()};a.exibeCalendarioDataMin=function(e){e&&(e.preventDefault(),e.stopPropagation()),a.abrirCalendarioDataMin=!a.abrirCalendarioDataMin,a.abrirCalendarioDataMax=!1},a.alterouDataMin=function(){p()},a.exibeCalendarioDataMax=function(e){e&&(e.preventDefault(),e.stopPropagation()),a.abrirCalendarioDataMax=!a.abrirCalendarioDataMax,a.abrirCalendarioDataMin=!1},a.alterouDataMax=function(){null===a.filtro.datamax?a.filtro.datamax="":p()};var m=function(e){if(a.usuariologado.grupoempresa&&null!==a.usuariologado.grupoempresa){a.showProgress(u,1e4);var o=[];o.push({id:114,valor:1}),a.usuariologado.grupoempresa&&(o.push({id:116,valor:a.usuariologado.grupoempresa.id_grupo}),a.usuariologado.empresa&&o.push({id:100,valor:a.usuariologado.empresa.nu_cnpj})),r.get(t.getUrl(t.cliente.empresa,[a.token,0,104],o)).then(function(o){a.filiais=o.Registros,a.filtro.destinatario=e?l("filter")(a.filiais,function(a){return a.nu_cnpj===e})[0]:null,a.hideProgress(u)},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter filiais ("+e.status+")",!0,"danger",!0),a.hideProgress(u)})}};a.alterouDestinatario=function(){},a.incrementaTotalNFes=function(e){"number"==typeof e&&(a.total.nfe+=e)},a.buscaManifestos=function(){if(!a.usuariologado.grupoempresa)return void a.showModalAlerta("Por favor, selecione uma empresa","Atos Capital","OK",function(){s(function(){a.setVisibilidadeBoxGrupoEmpresa(!0)},300)});if(a.filtro.datamax){var e=Math.abs(a.filtro.datamax.getTime()-a.filtro.datamin.getTime()),o=Math.ceil(e/864e5);if(o>31){var i=366>=o?o+" dias":"mais de um ano";return void a.showModalAlerta("Por favor, selecione um intervalo de data de no máximo 31 dias. (Sua seleção consta "+i+")","Atos Capital","OK",function(){s(function(){a.exibeCalendarioDataMax()},300)})}}h()};var h=function(){a.showProgress(u,1e4),a.showProgress(f);var e=g();void 0!=e?r.get(t.getUrl(t.tax.tbmanifesto,[a.token,5,108,0,a.filtro.itens_pagina,a.filtro.pagina],e)).then(function(o){if(d=e,a.total.nfe=0,a.manifestos=o.Registros,a.filtro.total_registros=o.TotalDeRegistros,a.filtro.total_paginas=Math.ceil(a.filtro.total_registros/a.filtro.itens_pagina),0===a.manifestos.length)a.faixa_registros="0-0";else{var i=(a.filtro.pagina-1)*a.filtro.itens_pagina+1,r=i-1+a.filtro.itens_pagina;r>a.filtro.total_registros&&(r=a.filtro.total_registros),a.filtro.faixa_registros=i+"-"+r}a.filtro.pagina>a.filtro.total_paginas&&c(1),a.hideProgress(u),a.hideProgress(f)},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter manifestos ("+e.status+")",!0,"danger",!0),a.hideProgress(u),a.hideProgress(f)}):2===a.tabFiltro&&(a.hideProgress(u),a.hideProgress(f),a.showModalAlerta("Por favor, digite a Chave de Acesso","Atos Capital","OK",function(){}))};a.toggle=function(a){a&&null!==a&&(a.collapsed=a.collapsed?!1:!0)},a.isExpanded=function(a){return a&&null!==a?a.collapsed:void 0},a.downloadDANFE=function(e,o){var i=void 0,r=3,s=e.nrEmitenteCNPJCPF+".zip";if("number"==typeof o){var n=e.notas[o];r=2,i={id:100,valor:n.idManifesto},s=n.nrChave+".pdf"}else d?(i=[],angular.copy(d,i),i.push({id:105,valor:e.nrEmitenteCNPJCPF})):i={id:105,valor:e.nrEmitenteCNPJCPF};a.download(t.getUrl(t.util.utilnfe,[a.token,r,108],i),s,!0,f,u)},a.downloadXML=function(e,o){var i=void 0,r=1,s=e.nrEmitenteCNPJCPF+".zip";if("number"==typeof o){var n=e.notas[o];r=0,i={id:100,valor:n.idManifesto},s=n.nrChave+".xml"}else d?(i=[],angular.copy(d,i),i.push({id:105,valor:e.nrEmitenteCNPJCPF})):i={id:105,valor:e.nrEmitenteCNPJCPF};a.download(t.getUrl(t.util.utilnfe,[a.token,r,108],i),s,!0,f,u)},a.getCodigoTracoDescricao=function(a){var e="";return a&&("number"==typeof a.codigo||"string"==typeof a.codigo?(e=a.codigo+"","string"==typeof a.descricao?e+=" - "+a.descricao:"string"==typeof a.nome&&(e+=" - "+a.nome)):"string"==typeof a.descricao?e=a.descricao:"string"==typeof a.nome&&(e=a.nome)),e};var v=function(e,o,i){a.showProgress(u,1e4),a.showProgress(f);var s={id:100,valor:e};r.get(t.getUrl(t.tax.tbmanifesto,[a.token,4],s)).then(function(e){a.notadetalhada=void 0,e.Registros.length>0&&(a.notadetalhada=e.Registros[0].notas[0],a.notadetalhada.nrChave=o),"function"==typeof i&&i(),a.hideProgress(u),a.hideProgress(f)},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter detalhes da NF-e ("+e.status+")",!0,"danger",!0),a.hideProgress(u),a.hideProgress(f)})},P=function(e,o){a.showProgress(u,1e4),a.showProgress(f);var i={id:200,valor:e};r.get(t.getUrl(t.rezende.pgsql.tbalmoxarifado,[a.token,1,100,0],i)).then(function(e){a.almoxarifados=void 0,e.Registros.length>0&&(a.almoxarifados=e.Registros),"function"==typeof o&&o(),a.hideProgress(u),a.hideProgress(f)},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.showAlert("Serviço indisponível no momento. Por favor tente mais tarde",!0,"warning",!0):a.showAlert("Houve uma falha ao obter os almaxorifados para importação ("+e.status+")",!0,"danger",!0),a.hideProgress(u),a.hideProgress(f)})};a.exibeCalendarioDataEntrada=function(e){e&&(e.preventDefault(),e.stopPropagation()),a.abrirCalendarioDataEntrada=!a.abrirCalendarioDataEntrada};var b=function(e,o){a.showProgress(u,1e4),a.showProgress(f),r.get(t.getUrl(t.rezende.pgsql.tbnaturezaoperacao,[a.token,e])).then(function(e){a.natOperacoes=void 0,e.Registros.length>0&&(a.natOperacoes=e.Registros),"function"==typeof o&&o(),a.hideProgress(u),a.hideProgress(f)},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.showAlert("Serviço indisponível no momento. Por favor tente mais tarde",!0,"warning",!0):a.showAlert("Houve uma falha ao obter a natureza da operação para importação da NFe("+e.status+")",!0,"danger",!0),a.hideProgress(u),a.hideProgress(f)})};a.detalhar=function(e,o){var i=e.notas[o];a.notadetalhada&&a.notadetalhada.idManifesto===i.idManifesto?$("#modalDetalhes").modal("show"):v(i.idManifesto,i.nrChave,function(){$("#modalDetalhes").modal("show")})},a.obterInformarcoesImportar=function(e,o){var i=e.notas[o],r=e.UF,t=1;return"SE"!=r&&(t=2),null==i.dtEntrega?void a.showModalAlerta("A nota não está disponível para importação, pois a mesma ainda não foi recebida."):(a.nrChave=i.nrChave,a.dtEntrega=i.dtEntrega,P(i.nrCNPJ,function(){$("#modalImportar").modal("show")}),b(t,function(){$("#modalImportar").modal("show")}),void 0)},a.importarNota=function(){if(!a.dadosImportacao||null===a.dadosImportacao)return void a.showModalAlerta("É necessário selecionar a Natureza da Operação e o Almoxarifado!");if(!a.dadosImportacao.natOperacao||null===a.dadosImportacao.natOperacao)return void a.showModalAlerta("É necessário selecionar a Natureza da Operação!");if(!a.dadosImportacao.almoxarifado||null===a.dadosImportacao.almoxarifado)return void a.showModalAlerta("É necessário selecionar o Almoxarifado!");if(!a.dtEntrega||null===a.dtEntrega)return void a.showModalAlerta("Favor informar a data de Entrada da Nota!");var e={nrChave:a.nrChave,codAlmoxarifado:a.dadosImportacao.almoxarifado.cod_almoxarifado,codNaturezaOperacao:a.dadosImportacao.natOperacao.cdNaturezaOperacao,dtEntrega:a.dtEntrega};a.showProgress(),r.post(t.getUrl(t.rezende.pgsql.tabnotafiscalentrada,void 0,{id:"token",valor:a.token}),e).then(function(e){a.hideProgress(),e&&null!=e?200===e.cdMensagem?(M(),a.showModalAlerta("Nota Fiscal incluída com sequência: "+e.sqNota+".")):(M(),a.Mensagens=e.Erro,w()):M()},function(e){M(),0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.showAlert("Serviço indisponível no momento. Por favor tente mais tarde",!0,"warning",!0):a.showAlert("Houve uma falha ao importar a NFe ("+e.status+")",!0,"danger",!0),a.hideProgress()}),a.dadosImportacao=null};var M=function(){$("#modalImportar").modal("hide")},w=function(){$("#modalRetornoImportacao").modal("show")};a.imprimir=function(e,o){var r=e.notas[o];i.open("views/impressao-nfe#?k="+r.nrChave+"&t="+a.token,"_blank")},a.tabIs=function(e){return a.tab===e},a.setTab=function(e){e>=1&&8>=e&&(a.tab=e)},a.tabFiltroIs=function(e){return a.tabFiltro===e},a.setTabFiltro=function(e){e>=1&&2>=e&&(a.tabFiltro=e)},a.exibeOpcaoImportar=function(){return!a.usuariologado.grupoempresa||6!==a.usuariologado.grupoempresa.id_grupo&&15!==a.usuariologado.grupoempresa.id_grupo?!1:!0}}]);