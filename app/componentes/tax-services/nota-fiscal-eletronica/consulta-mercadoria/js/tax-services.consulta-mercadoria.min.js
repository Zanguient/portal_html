angular.module("tax-services-consulta-mercadoria",[]).controller("tax-services-consulta-mercadoriaCtrl",["$scope","$state","$http","$window","$webapi","$apis","$timeout","$filter",function(a,e,o,i,t,r,s){a.confirmRecebimento=!1,a.paginaInformada=1,a.itens_pagina=[50,100,150,200],a.filtro={itens_pagina:a.itens_pagina[0],pagina:1,total_registros:0,faixa_registros:"0-0",total_paginas:0,chaveAcesso:null,cdMercadoria:null,dsMercadoria:null},a.classificacao={idMercadoria:null,nrNCM:null,prIPI:null,prICMS:null,prPIS:null,prCOFINS:null,dsObservacao:null,idUsers:null},a.tabFiltro=1;var l=0,u=1;a.exibeTela=!1,a.taxServices_consultaMercadoriaInit=function(){a.pagina.titulo="Nota Fiscal Eletrônica",a.pagina.subtitulo="Consulta Mercadoria",a.$on("mudancaDeRota",function(a,o,i){e.go(o,i)}),a.$on("alterouGrupoEmpresa",function(){a.exibeTela&&a.usuariologado.grupoempresa}),a.$on("acessoDeTelaNotificado",function(){a.exibeTela=!0}),a.exibeTela=!0},a.limpaFiltros=function(){ultimoFiltroBusca=void 0,a.filtro.cdMercadoria=null,a.filtro.dsMercadoria=null,a.filtro.chaveAcesso=null};var c=function(e){e>=1&&e<=a.filtro.total_paginas&&(a.filtro.pagina=e),a.atualizaPaginaDigitada()};a.retrocedePagina=function(){c(a.filtro.pagina-1)},a.avancaPagina=function(){c(a.filtro.pagina+1)},a.alteraPagina=function(){a.paginaInformada?c(parseInt(a.paginaInformada)):a.atualizaPaginaDigitada()},a.atualizaPaginaDigitada=function(){a.paginaInformada=a.filtro.pagina},a.alterouItensPagina=function(){};var f=function(){var e=[];if(1===a.tabFiltro){a.filtro.cdMercadoria&&""!==a.filtro.cdMercadoria&&e.push({id:103,valor:a.filtro.cdMercadoria}),a.filtro.dsMercadoria&&null!==a.filtro.dsMercadoria&&e.push({id:104,valor:a.filtro.dsMercadoria})}else a.filtro.chaveAcesso&&null!==a.filtro.chaveAcesso&&e.push({id:130,valor:a.filtro.chaveAcesso});return e.length>0?e:void 0};a.buscaMercadorias=function(){return a.usuariologado.grupoempresa?void d():void a.showModalAlerta("Por favor, selecione uma empresa","Atos Capital","OK",function(){s(function(){a.setVisibilidadeBoxGrupoEmpresa(!0)},300)})};var d=function(e){a.showProgress(l,1e4),a.showProgress(u);var o=[];e?o.push({id:100,valor:e}):o=f(),void 0!=o?(a.mercadorias=void 0,t.get(r.getUrl(r.tax.tbmercadoria,[a.token,1,104,0],o)).then(function(e){if(ultimoFiltroBusca=o,a.mercadorias=e.Registros,a.mercadorias.length>0&&(a.classificacao=a.mercadorias[0].ultimaClassificacao),a.filtro.total_registros=e.TotalDeRegistros,a.filtro.total_paginas=Math.ceil(a.filtro.total_registros/a.filtro.itens_pagina),0===a.mercadorias.length)a.faixa_registros="0-0";else{var i=(a.filtro.pagina-1)*a.filtro.itens_pagina+1,t=i-1+a.filtro.itens_pagina;t>a.filtro.total_registros&&(t=a.filtro.total_registros),a.filtro.faixa_registros=i+"-"+t}a.filtro.pagina>a.filtro.total_paginas&&c(1),a.hideProgress(l),a.hideProgress(u)},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter mercadorias ("+e.status+")",!0,"danger",!0),a.hideProgress(l),a.hideProgress(u)})):(a.mercadorias=void 0,a.hideProgress(l),a.hideProgress(u))};a.insereClassificacao=function(){return a.usuariologado.grupoempresa?void g():void a.showModalAlerta("Por favor, selecione uma empresa","Atos Capital","OK",function(){s(function(){a.setVisibilidadeBoxGrupoEmpresa(!0)},300)})};var g=function(){a.showProgress(l,1e4),a.showProgress(u),t.post(r.getUrl(r.tax.tbmercadoriaclassificada,void 0,{id:"token",valor:a.token}),a.classificacao).then(function(){a.hideProgress(l),a.hideProgress(u),d(a.classificacao.idMercadoria)},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao inserir uma classificação ("+e.status+")",!0,"danger",!0),a.hideProgress(l),a.hideProgress(u)})};a.detalhar=function(a,e){var o=a[e];console.log(o),p(o.nrChave,function(){$("#modalDetalhes").modal("show")})};var p=function(e,o){a.showProgress(l,1e4),a.showProgress(u);var i={id:101,valor:e};console.log(i),t.get(r.getUrl(r.tax.tbmanifesto,[a.token,4],i)).then(function(i){return a.notadetalhada=void 0,i.Registros.length>0?(a.notadetalhada=i.Registros[0].notas[0],a.notadetalhada.nrChave=e,"function"==typeof o&&o(),a.hideProgress(l),void a.hideProgress(u)):(a.hideProgress(l),a.hideProgress(u),void a.showModalAlerta("A Nota Fiscal não está disponível."))},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter detalhes da NF-e ("+e.status+")",!0,"danger",!0),a.hideProgress(l),a.hideProgress(u)})};a.toggle=function(a){a&&null!==a&&(a.collapsed=a.collapsed?!1:!0)},a.isExpanded=function(a){return console.log(a),a&&null!==a?a.collapsed:void 0},a.tabIs=function(e){return a.tab===e},a.setTab=function(e){e>=1&&8>=e&&(a.tab=e)},a.tabFiltroIs=function(e){return a.tabFiltro===e},a.setTabFiltro=function(e){e>=1&&2>=e&&(a.tabFiltro=e)}}]);