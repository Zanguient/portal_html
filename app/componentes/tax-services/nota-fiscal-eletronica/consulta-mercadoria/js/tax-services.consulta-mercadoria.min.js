angular.module("tax-services-consulta-mercadoria",[]).controller("tax-services-consulta-mercadoriaCtrl",["$scope","$state","$http","$window","$webapi","$apis","$timeout","$filter",function(a,i,e,r,o,t,s){a.confirmRecebimento=!1,a.paginaInformada=1,a.itens_pagina=[50,100,150,200],a.filtro={itens_pagina:a.itens_pagina[0],pagina:1,total_registros:0,faixa_registros:"0-0",total_paginas:0,chaveAcesso:null,cdMercadoria:null,dsMercadoria:null},a.classificacao={idMercadoria:null,nrNCM:null,prIPI:null,prICMS:null,prPIS:null,prCOFINS:null,dsObservacao:null,idUsers:null},a.tabFiltro=1;var l=0,u=1;a.exibeTela=!1,a.taxServices_consultaMercadoriaInit=function(){a.pagina.titulo="Nota Fiscal Eletrônica",a.pagina.subtitulo="Consulta Mercadoria",a.$on("mudancaDeRota",function(a,e,r){i.go(e,r)}),a.$on("alterouGrupoEmpresa",function(){a.exibeTela&&a.usuariologado.grupoempresa}),a.$on("acessoDeTelaNotificado",function(){a.exibeTela=!0}),a.exibeTela=!0},a.limpaFiltros=function(){ultimoFiltroBusca=void 0,a.filtro.cdMercadoria=null,a.filtro.dsMercadoria=null,a.filtro.chaveAcesso=null};var c=function(i){i>=1&&i<=a.filtro.total_paginas&&(a.filtro.pagina=i),a.atualizaPaginaDigitada()};a.retrocedePagina=function(){c(a.filtro.pagina-1)},a.avancaPagina=function(){c(a.filtro.pagina+1)},a.alteraPagina=function(){a.paginaInformada?c(parseInt(a.paginaInformada)):a.atualizaPaginaDigitada()},a.atualizaPaginaDigitada=function(){a.paginaInformada=a.filtro.pagina},a.alterouItensPagina=function(){};var f=function(){var i=[];if(1===a.tabFiltro){a.filtro.cdMercadoria&&""!==a.filtro.cdMercadoria&&i.push({id:103,valor:a.filtro.cdMercadoria}),a.filtro.dsMercadoria&&null!==a.filtro.dsMercadoria&&i.push({id:104,valor:a.filtro.dsMercadoria})}else a.filtro.chaveAcesso&&null!==a.filtro.chaveAcesso&&i.push({id:130,valor:a.filtro.chaveAcesso});return i.length>0?i:void 0};a.buscaMercadorias=function(){return a.usuariologado.grupoempresa?void d():void a.showModalAlerta("Por favor, selecione uma empresa","Atos Capital","OK",function(){s(function(){a.setVisibilidadeBoxGrupoEmpresa(!0)},300)})};var d=function(i){a.showProgress(l,1e4),a.showProgress(u);var e=[];i?e.push({id:100,valor:i}):e=f(),void 0!=e?(a.mercadorias=void 0,o.get(t.getUrl(t.tax.tbmercadoria,[a.token,1,104,0],e)).then(function(i){if(ultimoFiltroBusca=e,a.mercadorias=i.Registros,a.mercadorias.length>0&&(a.classificacao=a.mercadorias[0].ultimaClassificacao),a.filtro.total_registros=i.TotalDeRegistros,a.filtro.total_paginas=Math.ceil(a.filtro.total_registros/a.filtro.itens_pagina),0===a.mercadorias.length)a.faixa_registros="0-0";else{var r=(a.filtro.pagina-1)*a.filtro.itens_pagina+1,o=r-1+a.filtro.itens_pagina;o>a.filtro.total_registros&&(o=a.filtro.total_registros),a.filtro.faixa_registros=r+"-"+o}a.filtro.pagina>a.filtro.total_paginas&&c(1),a.hideProgress(l),a.hideProgress(u)},function(i){0===i.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===i.status||404===i.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter mercadorias ("+i.status+")",!0,"danger",!0),a.hideProgress(l),a.hideProgress(u)})):(a.mercadorias=void 0,a.hideProgress(l),a.hideProgress(u))};a.insereClassificacao=function(){return a.usuariologado.grupoempresa?void g():void a.showModalAlerta("Por favor, selecione uma empresa","Atos Capital","OK",function(){s(function(){a.setVisibilidadeBoxGrupoEmpresa(!0)},300)})};var g=function(){a.showProgress(l,1e4),a.showProgress(u),o.post(t.getUrl(t.tax.tbmercadoriaclassificada,void 0,{id:"token",valor:a.token}),a.classificacao).then(function(){a.hideProgress(l),a.hideProgress(u),d(a.classificacao.idMercadoria)},function(i){0===i.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===i.status||404===i.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao inserir uma classificação ("+i.status+")",!0,"danger",!0),a.hideProgress(l),a.hideProgress(u)})};a.toggle=function(a){a&&null!==a&&(a.collapsed=a.collapsed?!1:!0)},a.isExpanded=function(a){return a&&null!==a?a.collapsed:void 0},a.tabFiltroIs=function(i){return a.tabFiltro===i},a.setTabFiltro=function(i){i>=1&&2>=i&&(a.tabFiltro=i)}}]);