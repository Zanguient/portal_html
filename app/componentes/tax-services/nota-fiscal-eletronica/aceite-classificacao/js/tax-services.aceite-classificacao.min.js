angular.module("tax-services-aceite-classificacao",[]).controller("tax-services-aceite-classificacaoCtrl",["$scope","$state","$http","$window","$webapi","$apis","$timeout","$filter",function(a,e,i,t,s,o,r){a.paginaInformada=1,a.itens_pagina=[50,100,150,200],a.filtro={itens_pagina:a.itens_pagina[0],pagina:1,total_registros:0,faixa_registros:"0-0",total_paginas:0,chaveAcesso:null,cdMercadoria:null,dsMercadoria:null},a.classificacao={idMercadoria:null,nrNCM:null,dsNCM:null,dsCstICMS:null,prICMS:0,prBaseICMS:0,prEfetivaICMS:0,dsBaseLegalICMS:null,prIPI:0,dsCstIPI:null,dsBaseLegalIPI:null,prII:0,dsCstPisCofins:null,prPIS:0,prCOFINS:0,dsBaseLegalPisCofins:null,dsObservacao:null,idUsers:null,dtClassificacao:null,flAceite:null,idUsersAceite:null,dsMensagemAceite:null},a.tabFiltro=1,a.tab=1,a.tabDetalhes=1;var l=0,c=1;a.ultimaClassificacao=null,a.exibeTela=!1,a.taxServices_aceiteClassificacaoInit=function(){a.pagina.titulo="Nota Fiscal Eletrônica",a.pagina.subtitulo="Consulta Mercadoria",a.$on("mudancaDeRota",function(a,i,t){e.go(i,t)}),a.$on("alterouGrupoEmpresa",function(){a.exibeTela&&a.usuariologado.grupoempresa}),a.$on("acessoDeTelaNotificado",function(){a.exibeTela=!0}),a.exibeTela=!0},a.limpaFiltros=function(){ultimoFiltroBusca=void 0,a.filtro.cdMercadoria=null,a.filtro.dsMercadoria=null,a.filtro.chaveAcesso=null};var u=function(e){e>=1&&e<=a.filtro.total_paginas&&(a.filtro.pagina=e,d()),a.atualizaPaginaDigitada()};a.retrocedePagina=function(){u(a.filtro.pagina-1)},a.avancaPagina=function(){u(a.filtro.pagina+1)},a.alteraPagina=function(){a.paginaInformada?u(parseInt(a.paginaInformada)):a.atualizaPaginaDigitada()},a.atualizaPaginaDigitada=function(){a.paginaInformada=a.filtro.pagina},a.alterouItensPagina=function(){a.mercadorias.length>0&&d()};var f=function(){var e=[];if(1===a.tabFiltro){a.filtro.cdMercadoria&&""!==a.filtro.cdMercadoria&&e.push({id:103,valor:a.filtro.cdMercadoria}),a.filtro.dsMercadoria&&null!==a.filtro.dsMercadoria&&e.push({id:104,valor:a.filtro.dsMercadoria})}else a.filtro.chaveAcesso&&null!==a.filtro.chaveAcesso&&e.push({id:130,valor:a.filtro.chaveAcesso});return e.length>0?e:void 0};a.buscaMercadorias=function(){return a.usuariologado.grupoempresa?void d():void a.showModalAlerta("Por favor, selecione uma empresa","Atos Capital","OK",function(){r(function(){a.setVisibilidadeBoxGrupoEmpresa(!0)},300)})};var d=function(e){a.showProgress(l,1e4),a.showProgress(c);var i=[];e?i.push({id:100,valor:e}):i=f(),void 0!=i?(a.mercadorias=void 0,s.get(o.getUrl(o.tax.tbmercadoria,[a.token,1,104,0,a.filtro.itens_pagina,a.filtro.pagina],i)).then(function(e){if(ultimoFiltroBusca=i,a.mercadorias=e.Registros,a.mercadorias.length>0&&(a.classificacao=a.mercadorias[0].ultimaClassificacao),a.filtro.total_registros=e.TotalDeRegistros,a.filtro.total_paginas=Math.ceil(a.filtro.total_registros/a.filtro.itens_pagina),0===a.mercadorias.length)a.faixa_registros="0-0";else{var t=(a.filtro.pagina-1)*a.filtro.itens_pagina+1,s=t-1+a.filtro.itens_pagina;s>a.filtro.total_registros&&(s=a.filtro.total_registros),a.filtro.faixa_registros=t+"-"+s}a.filtro.pagina>a.filtro.total_paginas&&u(1),a.hideProgress(l),a.hideProgress(c)},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter mercadorias ("+e.status+")",!0,"danger",!0),a.hideProgress(l),a.hideProgress(c)})):(a.mercadorias=void 0,a.hideProgress(l),a.hideProgress(c))};a.buscaUltimaClassficacao=function(e,i){a.showProgress(l,1e4),a.showProgress(c);var t=e[i],r=[{id:101,valor:t.idMercadoria}];s.get(o.getUrl(o.tax.tbmercadoriaclassificada,[a.token,2],r)).then(function(e){a.classificacao=e.Registros[0],a.ultimaClassificacao=a.classificacao,a.hideProgress(l),a.hideProgress(c),g()},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter a última classificação ("+e.status+")",!0,"danger",!0),a.hideProgress(l),a.hideProgress(c)})};var g=function(){$("#modalClassificar").modal("show")},p=function(){$("#modalClassificar").modal("hide")};a.insereClassificacao=function(){if(!a.usuariologado.grupoempresa)return void a.showModalAlerta("Por favor, selecione uma empresa","Atos Capital","OK",function(){r(function(){a.setVisibilidadeBoxGrupoEmpresa(!0)},300)});if("string"==typeof a.classificacao.prICMS)try{a.classificacao.prICMS=parseFloat(a.classificacao.prICMS.split(".").join("").split(",").join("."))}catch(e){}if("string"==typeof a.classificacao.prEfetivaICMS)try{a.classificacao.prEfetivaICMS=parseFloat(a.classificacao.prEfetivaICMS.split(".").join("").split(",").join("."))}catch(e){}if("string"==typeof a.classificacao.prIPI)try{a.classificacao.prIPI=parseFloat(a.classificacao.prIPI.split(".").join("").split(",").join("."))}catch(e){}if("string"==typeof a.classificacao.prII)try{a.classificacao.prII=parseFloat(a.classificacao.prII.split(".").join("").split(",").join("."))}catch(e){}if("string"==typeof a.classificacao.prPIS)try{a.classificacao.prPIS=parseFloat(a.classificacao.prPIS.split(".").join("").split(",").join("."))}catch(e){}if("string"==typeof a.classificacao.prCOFINS)try{a.classificacao.prCOFINS=parseFloat(a.classificacao.prCOFINS.split(".").join("").split(",").join("."))}catch(e){}h()};var h=function(){a.showProgress(l,1e4),a.showProgress(c),s.post(o.getUrl(o.tax.tbmercadoriaclassificada,void 0,{id:"token",valor:a.token}),a.classificacao).then(function(){a.hideProgress(l),a.hideProgress(c),p(),a.showModalAlerta("Classificação inserida com sucesso!"),d(a.classificacao.idMercadoria)},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao inserir uma classificação ("+e.status+")",!0,"danger",!0),a.hideProgress(l),a.hideProgress(c),p()})};a.habilita=function(a){return null!==a.flAceite?!0:!1},a.aceite=function(e,i,t){return a.usuariologado.grupoempresa?void m(e,i,t):void a.showModalAlerta("Por favor, selecione uma empresa","Atos Capital","OK",function(){r(function(){a.setVisibilidadeBoxGrupoEmpresa(!0)},300)})};var m=function(e,i,t){a.showProgress(l,1e4),a.showProgress(c);var r=e.classificacoes[i],n={idMercadoriaClassificada:r.idMercadoriaClassificada,flAceite:t};s.update(o.getUrl(o.tax.tbmercadoriaclassificada,void 0,{id:"token",valor:a.token}),n).then(function(){r.flAceite=t,r.dsMensagemAceite="true"===t?"Classficação Aceita!":"Classificação Não Aceita!",a.hideProgress(l),a.hideProgress(c)},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao realizar o aceite da classificação ("+e.status+")",!0,"danger",!0),a.hideProgress(l),a.hideProgress(c)})};a.detalhar=function(a,e){var i=a[e];v(i.nrChave,function(){$("#modalDetalhes").modal("show")})};var v=function(e,i){a.showProgress(l,1e4),a.showProgress(c);var t={id:101,valor:e};s.get(o.getUrl(o.tax.tbmanifesto,[a.token,4],t)).then(function(t){return a.notadetalhada=void 0,t.Registros.length>0?(a.notadetalhada=t.Registros[0].notas[0],a.notadetalhada.nrChave=e,"function"==typeof i&&i(),a.hideProgress(l),void a.hideProgress(c)):(a.hideProgress(l),a.hideProgress(c),void a.showModalAlerta("A Nota Fiscal não está disponível."))},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter detalhes da NF-e ("+e.status+")",!0,"danger",!0),a.hideProgress(l),a.hideProgress(c)})};a.toggle=function(a){a&&null!==a&&(a.collapsed=a.collapsed?!1:!0)},a.isExpanded=function(a){return a&&null!==a?a.collapsed:void 0},a.tabIs=function(e){return a.tab===e},a.setTab=function(e){e>=1&&8>=e&&(a.tab=e)},a.tabDetalhesIs=function(e){return a.tabDetalhes===e},a.setTabDetalhes=function(e){e>=1&&2>=e&&(a.tabDetalhes=e)},a.tabFiltroIs=function(e){return a.tabFiltro===e},a.setTabFiltro=function(e){e>=1&&2>=e&&(a.tabFiltro=e)}}]);