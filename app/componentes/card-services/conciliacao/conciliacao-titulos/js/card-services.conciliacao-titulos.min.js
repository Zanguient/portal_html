angular.module("card-services-conciliacao-titulos",[]).controller("card-services-conciliacao-titulosCtrl",["$scope","$state","$filter","$timeout","$http","$webapi","$apis",function(a,o,i,t,e,r,l){a.itens_pagina=[50,100,150,200],a.paginaInformada=1,a.dadosconciliacao=[],a.totais={valorTotal:0,contTitulos:0,contRecebimentosParcela:0};var n=0;a.adquirentes=[],a.filiais=[],a.tipos=[{id:1,nome:"CONCILIADO"},{id:2,nome:"PRÉ-CONCILIADO"},{id:3,nome:"NÃO CONCILIADO"}],a.filtro={datamin:new Date,datamax:"",tipo:null,adquirente:void 0,filial:void 0,itens_pagina:a.itens_pagina[1],order:0,pagina:1,total_registros:0,faixa_registros:"0-0",total_paginas:0};var s=0,u=1;a.modalBuscaTitulos={recebimento:null,titulos:[],buscandotitulos:!1};var c=!1;a.exibeTela=!1,a.abrirCalendarioDataMin=a.abrirCalendarioDataVendaMin=!1,a.abrirCalendarioDataMax=a.abrirCalendarioDataVendaMax=!1,a.cardServices_conciliacaoTitulosInit=function(){a.pagina.titulo="Card Services",a.pagina.subtitulo="Conciliação de Títulos",a.$on("mudancaDeRota",function(a,i,t){o.go(i,t)}),a.$on("alterouGrupoEmpresa",function(o){a.exibeTela&&(a.usuariologado.grupoempresa?(a.filtro.filial=a.filtro.adquirente=null,m(!0)):(a.dadosconciliacao=[],a.filiais=[],a.filtro.filial=a.filtro.adquirente=null,a.filtro.faixa_registros="0-0",a.filtro.total_registros=0,a.filtro.pagina=1,a.totais.valorTotal=0,a.totais.contTitulos=0,a.totais.contRecebimentosParcela=0))}),a.methodsDoControllerCorrente&&(c=a.methodsDoControllerCorrente["atualização"]?!0:!1),a.$on("acessoDeTelaNotificado",function(o){a.exibeTela=!0,a.usuariologado.grupoempresa&&m(!0)}),a.$emit("acessouTela")},a.usuarioPodeAlterarDadosConciliacaoTitulos=function(){return c},a.limpaFiltros=function(){a.filtro.datamin=new Date,a.filtro.datamax="",a.filtro.adquirente=a.filtro.tipo=null,a.filiais.length>0&&a.filtro.filial!==a.filiais[0]&&(a.filtro.filial=a.filiais[0],g(!1))};var f=function(){var o=[],i={id:100,valor:a.getFiltroData(a.filtro.datamin)};if(a.filtro.datamax&&(i.valor=i.valor+"|"+a.getFiltroData(a.filtro.datamax)),o.push(i),a.filtro.filial&&null!==a.filtro.filial){var t={id:103,valor:a.filtro.filial.nu_cnpj};o.push(t)}if(a.filtro.adquirente&&null!==a.filtro.adquirente){var e={id:200,valor:a.filtro.adquirente.cdAdquirente};o.push(e)}if(a.filtro.tipo&&null!==a.filtro.tipo){var r={id:101,valor:a.filtro.tipo.id};o.push(r)}return o},d=function(){a.filtro.datamax&&a.filtro.datamax<a.filtro.datamin&&(a.filtro.datamax=a.filtro.datamin),a.$$phase||a.$apply()};a.exibeCalendarioDataMin=function(o){o&&(o.preventDefault(),o.stopPropagation()),a.abrirCalendarioDataMin=!a.abrirCalendarioDataMin,a.abrirCalendarioDataMax=!1},a.alterouDataMin=function(){d()},a.exibeCalendarioDataMax=function(o){o&&(o.preventDefault(),o.stopPropagation()),a.abrirCalendarioDataMax=!a.abrirCalendarioDataMax,a.abrirCalendarioDataMin=!1},a.alterouDataMax=function(){null===a.filtro.datamax?a.filtro.datamax="":d()};var m=function(o,t,e){a.showProgress(s,1e4);var n=[];n.push({id:114,valor:1}),a.usuariologado.grupoempresa&&(n.push({id:116,valor:a.usuariologado.grupoempresa.id_grupo}),a.usuariologado.empresa&&n.push({id:100,valor:a.usuariologado.empresa.nu_cnpj})),r.get(l.getUrl(l.cliente.empresa,[a.token,0,104],n)).then(function(r){a.filiais=r.Registros,t?a.filtro.filial=i("filter")(a.filiais,function(a){return a.nu_cnpj===t})[0]:a.filtro.filial=a.filiais[0],o?g(!0,e):a.hideProgress(s)},function(o){0===o.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===o.status||404===o.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter filiais ("+o.status+")",!0,"danger",!0),a.hideProgress(s)})};a.alterouFilial=function(){g(!1)};var g=function(o,t){o||a.showProgress(s,1e4);var e=[{id:103,valor:1}];a.filtro.filial&&null!==a.filtro.filial&&e.push({id:305,valor:a.filtro.filial.nu_cnpj}),r.get(l.getUrl(l.card.tbadquirente,[a.token,0,101],e)).then(function(o){a.adquirentes=o.Registros,t?a.filtro.adquirente=i("filter")(a.adquirentes,function(a){return a.cdAdquirente===t})[0]:a.filtro.adquirente=a.adquirentes[0],a.hideProgress(s)},function(o){0===o.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===o.status||404===o.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter adquirentes ("+o.status+")",!0,"danger",!0),a.hideProgress(s)})};a.alterouAdquirente=function(){},a.isTipoPreConciliado=function(){return!a.filtro.tipo||null===a.filtro.tipo||a.filtro.tipo.id===a.tipos[1].id},a.alterouTipo=function(){},a.temElementosPreConciliados=function(){return n>0},a.incrementaTotalPreConciliados=function(a){a&&n++};var p=function(o){o>=1&&o<=a.filtro.total_paginas&&(a.filtro.pagina=o,a.buscaDadosConciliacao()),a.atualizaPaginaDigitada()};a.retrocedePagina=function(){p(a.filtro.pagina-1)},a.avancaPagina=function(){p(a.filtro.pagina+1)},a.alteraPagina=function(){a.paginaInformada?p(parseInt(a.paginaInformada)):a.atualizaPaginaDigitada()},a.atualizaPaginaDigitada=function(){a.paginaInformada=a.filtro.pagina},a.alterouItensPagina=function(){a.dadosconciliacao.length>0&&a.buscaDadosConciliacao()},a.buscaDadosConciliacao=function(){if(!a.usuariologado.grupoempresa)return void a.showModalAlerta("Por favor, selecione uma empresa","Atos Capital","OK",function(){t(function(){a.setVisibilidadeBoxGrupoEmpresa(!0)},300)});if(!a.filtro.adquirente||null===a.usuariologado.adquirente)return void a.showModalAlerta("É necessário selecionar uma adquirente!");if(a.filtro.datamax){var o=Math.abs(a.filtro.datamax.getTime()-a.filtro.datamin.getTime()),i=Math.ceil(o/864e5);if(i>31){var e=366>=i?i+" dias":"mais de um ano";return void a.showModalAlerta("Por favor, selecione um intervalo de data de no máximo 31 dias. (Sua seleção consta "+e+")","Atos Capital","OK",function(){t(function(){a.exibeCalendarioDataMax()},300)})}}v()};var v=function(o){if(a.usuariologado.grupoempresa&&a.filtro.adquirente&&null!==a.usuariologado.adquirente){o||(a.showProgress(s,1e4),a.showProgress(u));var i=f();r.get(l.getUrl(l.card.conciliacaotitulos,[a.token,0,100,0,a.filtro.itens_pagina,a.filtro.pagina],i)).then(function(o){if(a.totais.contTitulos=a.totais.contRecebimentosParcela=n=0,a.dadosconciliacao=o.Registros,a.totais.valorTotal=o.Totais.valor,a.filtro.total_registros=o.TotalDeRegistros,a.filtro.total_paginas=Math.ceil(a.filtro.total_registros/a.filtro.itens_pagina),0===a.dadosconciliacao.length)a.filtro.faixa_registros="0-0";else{var i=(a.filtro.pagina-1)*a.filtro.itens_pagina+1,t=i-1+a.filtro.itens_pagina;t>a.filtro.total_registros&&(t=a.filtro.total_registros),a.filtro.faixa_registros=i+"-"+t}a.filtro.pagina>a.filtro.total_paginas&&p(1),a.hideProgress(s),a.hideProgress(u)},function(o){0===o.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===o.status||404===o.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter dados da conciliação de títulos ("+o.status+")",!0,"danger",!0),a.hideProgress(s),a.hideProgress(u)})}};a.incrementaContRecebimentosParcelas=function(o){null!=o&&(a.totais.contRecebimentosParcela+=1)},a.incrementaContTitulos=function(o){null!=o&&(a.totais.contTitulos+=1)},a.desconcilia=function(o){var i=angular.copy(o);i.Titulo.Id=-1,a.showModalConfirmacao("Confirmação","Tem certeza que deseja desfazer a conciliação selecionada?",h,[i],"Sim","Não")},a.concilia=function(o){a.showModalConfirmacao("Confirmação","Uma vez confirmada a conciliação, o título e a carga não poderão se envolver em outra conciliação de títulos. Confirma essa conciliação?",h,[o],"Sim","Não")},a.conciliaPreConciliados=function(){var o=i("filter")(a.dadosconciliacao,function(a){return 2===a.Conciliado}),t=o.length;if(0===t)return void a.showModalAlerta("Não há dados pré-conciliados em exibição!");var e="";e+=1===t?"Foi encontrada 1 pré-conciliação. Uma vez confirmada a conciliação, o título e a carga não poderão se envolver em outra conciliação de títulos. Confirma essa conciliação?":"Foram encontradas "+t+" pré-conciliações. Uma vez confirmadas as conciliações, os títulos e as cargas não poderão se envolver em outra conciliação de títulos. Confirma essas conciliações?",a.showModalConfirmacao("Confirmação",e,h,o,"Sim","Não")};var h=function(o,i){a.showProgress(s,1e4),a.showProgress(u);for(var t=[],e=0;e<o.length;e++){var n=o[e];t.push({idRecebimentoTitulo:parseInt(n.Titulo.Id),recebimentoParcela:{idRecebimento:parseInt(n.RecebimentoParcela.Id),numParcela:parseInt(n.RecebimentoParcela.NumParcela)}})}r.update(l.getUrl(l.card.conciliacaotitulos,void 0,{id:"token",valor:a.token}),t).then(function(e){if(i||-1===t[0].idRecebimentoTitulo)v(!0);else{for(var r=0;r<o.length;r++)o[r].Conciliado=1;a.$$phase||a.$apply(),a.hideProgress(s),a.hideProgress(u)}},function(o){0===o.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===o.status||404===o.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao realizar a conciliação de títulos ("+o.status+")",!0,"danger",!0),a.hideProgress(s),a.hideProgress(u)})};a.buscaTitulos=function(o){o.RecebimentoParcela&&null!==o.RecebimentoParcela&&(a.modalBuscaTitulos.recebimento=o.RecebimentoParcela,a.modalBuscaTitulos.titulos=[],$("#modalTitulos").modal("show"),C())};var b=function(){$("#modalTitulos").modal("hide")},C=function(){if(a.modalBuscaTitulos.recebimento&&null!==a.modalBuscaTitulos.recebimento){a.modalBuscaTitulos.buscandotitulos=!0,a.showProgress();var o=[{id:300,valor:a.modalBuscaTitulos.recebimento.Id},{id:301,valor:a.modalBuscaTitulos.recebimento.NumParcela}];r.get(l.getUrl(l.card.conciliacaotitulos,[a.token,1],o)).then(function(o){a.modalBuscaTitulos.titulos=o.Registros,a.modalBuscaTitulos.buscandotitulos=!1,a.hideProgress()},function(o){0===o.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===o.status||404===o.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao consultar títulos ("+o.status+")",!0,"danger",!0),a.modalBuscaTitulos.buscandotitulos=!1,a.hideProgress()})}};a.conciliarTitulo=function(o){var e={RecebimentoParcela:a.modalBuscaTitulos.recebimento,Titulo:o};a.showModalConfirmacao("Confirmação","Uma vez confirmada a conciliação, o título e a carga não poderão se envolver em outra conciliação de títulos. Confirma essa conciliação da parcela com valor de "+i("currency")(a.modalBuscaTitulos.recebimento.Valor,"R$",2)+" e o título com valor de "+i("currency")(o.Valor,"R$",2)+" (diferença de "+i("currency")(Math.abs(o.Valor-a.modalBuscaTitulos.recebimento.Valor),"R$",2)+")?",function(){b(),t(function(){h([e],!0)},300)},void 0,"Sim","Não")}}]);