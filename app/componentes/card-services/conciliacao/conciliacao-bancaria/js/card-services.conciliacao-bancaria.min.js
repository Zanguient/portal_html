angular.module("card-services-conciliacao-bancaria",[]).controller("card-services-conciliacao-bancariaCtrl",["$scope","$state","$filter","$timeout","$http","$webapi","$apis",function(a,e,t,o,i,r,n){a.itens_pagina=[50,100,150,200],a.paginaInformada=1,a.dadosconciliacao=[],a.totais={totalExtrato:0,totalRecebimentosParcela:0,contExtrato:0,contRecebimentosParcela:0};var s=0;a.adquirentes=[],a.filiais=[],a.tipos=[{id:1,nome:"CONCILIADO"},{id:2,nome:"PRÉ-CONCILIADO"},{id:3,nome:"NÃO CONCILIADO"}],a.filtro={datamin:new Date,datamax:"",consideraPeriodo:!0,tipo:null,adquirente:void 0,filial:void 0,itens_pagina:a.itens_pagina[1],order:0,pagina:1,total_registros:0,faixa_registros:"0-0",total_paginas:0};var l=0,u=1;a.modalDetalhes={grupo:[]},a.modalDataRecebimento={dado:void 0,data:"",dataValida:!1};var d=!1,c=!1,f=!1;a.exibeTela=!1,a.abrirCalendarioDataMin=a.abrirCalendarioDataVendaMin=!1,a.abrirCalendarioDataMax=a.abrirCalendarioDataVendaMax=!1,a.cardServices_conciliacaoBancariaInit=function(){a.pagina.titulo="Card Services",a.pagina.subtitulo="Conciliação Bancária",a.$on("mudancaDeRota",function(a,t,o){e.go(t,o)}),a.$on("alterouGrupoEmpresa",function(e){a.exibeTela&&(a.usuariologado.grupoempresa?(a.filtro.filial=a.filtro.adquirente=null,p()):(a.dadosconciliacao=[],a.filiais=[],a.filtro.filial=a.filtro.adquirente=null))}),a.methodsDoControllerCorrente&&(d=a.methodsDoControllerCorrente["atualização"]?!0:!1,c=a.methodsDoControllerCorrente.cadastro?!0:!1,f=a.methodsDoControllerCorrente["remoção"]?!0:!1),a.$on("acessoDeTelaNotificado",function(e){a.exibeTela=!0,a.usuariologado.grupoempresa&&p()}),a.$emit("acessouTela")},a.usuarioPodeCadastrarDadosConciliacaoBancaria=function(){return c},a.usuarioPodeAlterarDadosConciliacaoBancaria=function(){return d},a.usuarioPodeExcluirDadosConciliacaoBancaria=function(){return f},a.limpaFiltros=function(){a.filtro.datamin=new Date,a.filtro.datamax="",a.filtro.adquirente=a.filtro.tipo=null,a.filiais.length>0&&a.filtro.filial!==a.filiais[0]&&(a.filtro.filial=a.filiais[0],h(!1))};var g=function(){var e=[];if(a.filtro.consideraPeriodo){var t={id:100,valor:a.getFiltroData(a.filtro.datamin)};a.filtro.datamax&&(t.valor=t.valor+"|"+a.getFiltroData(a.filtro.datamax)),e.push(t)}if(a.filtro.filial&&null!==a.filtro.filial){var o={id:103,valor:a.filtro.filial.nu_cnpj};e.push(o)}if(a.filtro.adquirente&&null!==a.filtro.adquirente){var i={id:200,valor:a.filtro.adquirente.id};e.push(i)}if(a.filtro.tipo&&null!==a.filtro.tipo){var r={id:101,valor:a.filtro.tipo.id};e.push(r)}return e},m=function(){a.filtro.datamax&&a.filtro.datamax<a.filtro.datamin&&(a.filtro.datamax=a.filtro.datamin),a.$$phase||a.$apply()};a.exibeCalendarioDataMin=function(e){e&&(e.preventDefault(),e.stopPropagation()),a.abrirCalendarioDataMin=!a.abrirCalendarioDataMin,a.abrirCalendarioDataMax=!1},a.alterouDataMin=function(){m()},a.exibeCalendarioDataMax=function(e){e&&(e.preventDefault(),e.stopPropagation()),a.abrirCalendarioDataMax=!a.abrirCalendarioDataMax,a.abrirCalendarioDataMin=!1},a.alterouDataMax=function(){null===a.filtro.datamax?a.filtro.datamax="":m()};var p=function(e,o){a.showProgress(l,1e4);var i=void 0;a.usuariologado.grupoempresa&&(i=[{id:116,valor:a.usuariologado.grupoempresa.id_grupo}],a.usuariologado.empresa&&i.push({id:100,valor:a.usuariologado.empresa.nu_cnpj})),r.get(n.getUrl(n.cliente.empresa,[a.token,0,104],i)).then(function(i){a.filiais=i.Registros,e?a.filtro.filial=t("filter")(a.filiais,function(a){return a.nu_cnpj===e})[0]:a.filtro.filial=a.filiais[0],a.filtro.filial&&null!==a.filtro.filial?h(!0,o):a.hideProgress(l)},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter filiais ("+e.status+")",!0,"danger",!0),a.hideProgress(l)})};a.alterouFilial=function(){h(!1)};var h=function(e,o){if(!a.filtro.filial||null===a.filtro.filial)return void(a.filtro.adquirente=null);e||a.showProgress(l,1e4);var i=void 0;i={id:300,valor:a.filtro.filial.nu_cnpj},r.get(n.getUrl(n.pos.operadora,[a.token,0,101],i)).then(function(e){a.adquirentes=e.Registros,o?a.filtro.adquirente=t("filter")(a.adquirentes,function(a){return a.id===o})[0]:a.filtro.adquirente=a.adquirentes[0],a.hideProgress(l)},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter adquirentes ("+e.status+")",!0,"danger",!0),a.hideProgress(l)})};a.alterouAdquirente=function(){},a.isTipoNaoConciliado=function(){return a.filtro.tipo&&null!==a.filtro.tipo&&a.filtro.tipo.id===a.tipos[2].id},a.alterouTipo=function(){a.isTipoNaoConciliado()||(a.filtro.consideraPeriodo=!0)},a.selecionouCheckboxSemData=function(){},a.temElementosPreConciliados=function(){return s>0},a.incrementaTotalPreConciliados=function(a){a&&s++};var v=function(e){e>=1&&e<=a.filtro.total_paginas&&(a.filtro.pagina=e,a.buscaDadosConciliacao()),a.atualizaPaginaDigitada()};a.retrocedePagina=function(){v(a.filtro.pagina-1)},a.avancaPagina=function(){v(a.filtro.pagina+1)},a.alteraPagina=function(){a.paginaInformada?v(parseInt(a.paginaInformada)):a.atualizaPaginaDigitada()},a.atualizaPaginaDigitada=function(){a.paginaInformada=a.filtro.pagina},a.alterouItensPagina=function(){a.dadosconciliacao.length>0&&a.buscaDadosConciliacao()},a.buscaDadosConciliacao=function(){if(!a.usuariologado.grupoempresa)return void a.showModalAlerta("Por favor, selecione uma empresa","Atos Capital","OK",function(){o(function(){a.setVisibilidadeBoxGrupoEmpresa(!0)},300)});if(null===a.filtro.filial)return void a.showModalAlerta("É necessário selecionar uma filial!");if(a.filtro.datamax){var e=Math.abs(a.filtro.datamax.getTime()-a.filtro.datamin.getTime()),t=Math.ceil(e/864e5);if(t>31){var i=366>=t?t+" dias":"mais de um ano";return void a.showModalAlerta("Por favor, selecione um intervalo de data de no máximo 31 dias. (Sua seleção consta "+i+")","Atos Capital","OK",function(){o(function(){a.exibeCalendarioDataMax()},300)})}}b()};var b=function(e){if(a.usuariologado.grupoempresa&&a.filtro.filial&&null!==a.filtro.filial){e||(a.showProgress(l,1e4),a.showProgress(u));var t=g();r.get(n.getUrl(n.card.conciliacaobancaria,[a.token,0,100,0,a.filtro.itens_pagina,a.filtro.pagina],t)).then(function(e){if(a.totais.contExtrato=a.totais.contRecebimentosParcela=s=0,a.dadosconciliacao=e.Registros,a.totais.totalExtrato=e.Totais.valorExtrato,a.totais.totalRecebimentosParcela=e.Totais.valorRecebimento,a.filtro.total_registros=e.TotalDeRegistros,a.filtro.total_paginas=Math.ceil(a.filtro.total_registros/a.filtro.itens_pagina),0===a.dadosconciliacao.length)a.filtro.faixa_registros="0-0";else{var t=(a.filtro.pagina-1)*a.filtro.itens_pagina+1,o=t-1+a.filtro.itens_pagina;o>a.filtro.total_registros&&(o=a.filtro.total_registros),a.filtro.faixa_registros=t+"-"+o}a.filtro.pagina>a.filtro.total_paginas&&v(1),a.hideProgress(l),a.hideProgress(u)},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao obter dados da conciliação bancária ("+e.status+")",!0,"danger",!0),a.hideProgress(l),a.hideProgress(u)})}};a.incrementaContRecebimentosParcelas=function(e){null!=e&&(a.totais.contRecebimentosParcela+=e.length)},a.incrementaContExtratoBancario=function(e){null!=e&&(a.totais.contExtrato+=e.length)},a.detalhar=function(e){a.modalDetalhes.grupo=e,$("#modalDetalhes").modal("show")},a.concilia=function(e){var t=e.RecebimentosParcela.length>1?"as cargas":"a carga";a.showModalConfirmacao("Confirmação","Uma vez confirmada a conciliação, a movimentação e "+t+" não poderão se envolver em outra conciliação bancária. Confirma essa conciliação?",_,[e],"Sim","Não")},a.conciliaPreConciliados=function(){var e=t("filter")(a.dadosconciliacao,function(a){return 2===a.Conciliado}),o=e.length;if(0===o)return void a.showModalAlerta("Não há dados pré-conciliados em exibição!");var i="";1===o?(i+="Foi encontrada 1 pré-conciliação. Uma vez confirmada a conciliação, a movimentação e ",i+=e[0].RecebimentosParcela.length>1?"as cargas não poderão se envolver em outra conciliação bancária. Confirma essa conciliação?":"a carga"):i+="Foram encontradas "+o+" pré-conciliações. Uma vez confirmadas as conciliações, as movimentações e as cargas não poderão se envolver em outra conciliação bancária. Confirma essas conciliações?",a.showModalConfirmacao("Confirmação",i,_,e,"Sim","Não")};var _=function(e){a.showProgress(l,1e4),a.showProgress(u);for(var t=[],o=0;o<e.length;o++){for(var i=e[o],s={idExtrato:parseInt(i.ExtratoBancario[0].Id),idsRecebimento:[]},d=0;d<i.RecebimentosParcela.length;d++)s.idsRecebimento.push(i.RecebimentosParcela[d].Id);t.push(s)}r.update(n.getUrl(n.card.conciliacaobancaria,void 0,{id:"token",valor:a.token}),t).then(function(t){for(var o=0;o<e.length;o++)e[o].Conciliado=1;a.$$phase||a.$apply(),a.hideProgress(l),a.hideProgress(u)},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao realizar a conciliação bancária ("+e.status+")",!0,"danger",!0),a.hideProgress(l),a.hideProgress(u)})},C=function(){$("#modalDataRecebimento").modal("hide")},A=function(){$("#modalDataRecebimento").modal("show")};a.alteraDataRecebimento=function(){if(!a.modalDataRecebimento.dataValida)return void a.showModalAlerta("Data informada é inválida!");if(a.getDataString(a.modalDataRecebimento.dado.Data)===a.modalDataRecebimento.data)return void C();a.showProgress(l,1e4),a.showProgress(u);for(var e={dtaRecebimento:a.getDataFromString(a.modalDataRecebimento.data),idsRecebimento:[]},t=0;t<a.modalDataRecebimento.dado.RecebimentosParcela.length;t++)e.idsRecebimento.push(a.modalDataRecebimento.dado.RecebimentosParcela[t].Id);r.update(n.getUrl(n.pos.recebimentoparcela,void 0,{id:"token",valor:a.token}),e).then(function(a){C(),b(!0)},function(e){0===e.status?a.showAlert("Falha de comunicação com o servidor",!0,"warning",!0):503===e.status||404===e.status?a.voltarTelaLogin():a.showAlert("Houve uma falha ao alterar data de recebimento ("+e.status+")",!0,"danger",!0),a.hideProgress(l),a.hideProgress(u)})},a.exibeModalDataRecebimento=function(e){a.modalDataRecebimento.dado=e,a.modalDataRecebimento.data=a.getDataString(e.Data),a.modalDataRecebimento.dataValida=!0,A()},a.validaData=function(){if(a.modalDataRecebimento.data)if(a.modalDataRecebimento.data.length<10)a.modalDataRecebimento.dataValida=!1;else{var e=a.modalDataRecebimento.data.split("/"),t=new Date(e[2],e[1]-1,e[0]);a.modalDataRecebimento.dataValida=e[0]==t.getDate()&&e[1]-1==t.getMonth()&&e[2]==t.getFullYear()}else a.modalDataRecebimento.dataValida=!1}}]);